---

layout: post
title: "[infra] Raspberry pi로 wordpress 이전기(1)"
date: 2025-06-02 +0900
last_modified_at: 2025-06-02 13:00:00 +0900
tags: [raspberry pi, word press]
math: true

---
blog infra 전환기

개인적으로 사용하던 클라우드 서비스에서 사용하던 word press를 집에서 사용하던 라즈베리파이 5로 이전했다.

옮긴이유
 -  한달에 3만원씩 나가는 비용이 아까웠다.


집에서 운영중인 라즈베리파이 5가 있고 이를 통해서 집 내부에서 사용할 cloud서비스를 운영중이었다. CPU와 Memory가 여유로워서 사용이 가능했다.


main point
1. 보안
 - 포트포워딩
 - 디도스
 - admin 페이지 접근문제
2. 인프라 문제(고정아이피)
 - 일반적으로 요즘에는 퍼플릭 아이피가 잘 바뀌지는 않지만 고정은 아니기에 이걸 그냥 쓰기에는 어렵다.
3. 전기세 < 클라우드 운용비용
 - 일단 라즈베리파이 5는 5w정도를 쓰고 다른 것을 다 포함해도(NVME ssd) 10w전후이고 이는 한달에 1000원 전후이다. 누진세 구간을 넘으면 1000원이 넘는 수준.

3번을 제외하고 1,2번은 어떻게 접근해서 해결해야 할까?


일단, word press는 크게 php부분과 데이터를 가지고 있는 db부분이 있는데, db부분은 mysql, mariadb을 사용한다.

먼저 word press프로젝트는 docker compose를 이용해서 올렸다.(요즘은 LLM이 너무나 잘 만들어주기에 만들어준 스크립트 살짝만 맞춰서 진행)


1. 포트포워딩, 디도스 문제
 - Cloudflare에는 tunneling 이라는 서비스를 제공한다 TCP기반의 프로토콜을 서버의 outbound만을 가지고 우회하는 기술이다. 서버 내부에 cloudflare의 daemon을 설치해서 우회한다.(사실 ssh도 client쪽에서 outbound로 proxy를 열어서 packet을 받을수 있으니 그런 비슷한 기술이 아닐까 싶다. 난 cloudflare를 신뢰해서 이런 기술을 받아 들였다.)
 - cloudflare를 쓰면 ddos는 어느정도 알아서 막아준다(free tier) 그래서 자동으로 해결된다.
 - cloudflare free tier도 월 1000gb정도의 데이터 전송을 지원해주기 때문에 큰 무리없이 쓸수 있다.
2. 아이피 문제
 - cloudflare를 쓰면 ip가 클라우드 플레어가 된다. 일종의 reverse proxy이기 때문에 내가 신경쓸 필요가 없다.


-> 이렇게 쓰고 보니까 cloudflare 광고글이 되어버린 것 같은데, 받은건 전혀 없고 나도 무료 기능들을 천천히 살피는 중이다.

봇 막아주는 기능, waf기능, limit rate(과도하게 api호출시 막아주는 기능) 등등이 있다.


보안 문제에서 또 놓치면 안되는 부분이 /wp-admin.php 아래가 퍼블릭에 노출된다는 것이다. 이것을 어떻게 안전하게 해줄지 고민이 많았다.

wordpress는 접근 url을 어드민 차원에서 관리하는 기능을 제공한다.
home, siteurl 이라는 두가지 변수가 있다.
home: 외부에 공개되는 url
siteurl: wp-admin.php, wp-content와 같은 것들을 들어갈 수 있는 url

처음에는 siteurl을 내부네트워크에서만 접근가능하도록 해서 막을려고 했었다... 그런데 문제는 이미지 같은 것들도 이 url을 이용해야하고 이것을 위해서는 php코드를 수정해서 dockerfile을 다시 만들어서 배포해야하는 너무나도 번거로움이 있어서 일단 그냥 둘을 같게 유지한 상태에서 해결 방법을 찾아봤다.

1. wp 앞에 nginx나 caddy를 달고 해당 path에 auth를 하나 걸어준다.(프록시를 한번 더 거는것..)
2. 로그인 하고나서 2fa를 걸어주는 방법

그냥 2번이 1번보다 공수가 적어서 2번으로 처리하고 google auth를 믿어보기로 했다.


cloudflare에 url path를 제한하는 기능이 있어서 login.php와 wp-admin쪽을 접속 인가 받은 사용자만 가능하도록 추가했다.


현재 서비스는 잘 운영중이다. 이렇게만 하면 끝난 것일까?? 아니다. 모니터링도 해야한다!!
